version: '3.8'

# ====================================================
# ESTRATÉGIA DE DEPLOYMENT: Otimização Radical (V2)
# - DNS Fixo: 8.8.8.8 para resolver conexão Supabase
# - Banco de Dados: Externo (Supabase)
# - Limite de Memória: 2GB RAM total
# ====================================================

services:
  # ====== CACHE ======
  redis:
    image: redis:7-alpine
    container_name: conecta-redis
    restart: unless-stopped
    ports:
      - '6379:6379'
    command: redis-server --maxmemory 64m --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 64M

  # ====== BACKEND API ======
  backend:
    build:
      context: ./back/backend
      dockerfile: Dockerfile
    container_name: conecta-backend
    restart: unless-stopped
    env_file: .env
    dns:
      - 8.8.8.8
      - 1.1.1.1
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - '8082:8000'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 350M

  # ====== MODEL LLM ======
  model-llm:
    build:
      context: ./model-LLM
      dockerfile: Dockerfile
    container_name: conecta-model-llm
    restart: unless-stopped
    env_file: .env
    dns:
      - 8.8.8.8
    ports:
      - '8001:8002'
    deploy:
      resources:
        limits:
          memory: 256M

  # ====== SERVICE LLM (RAG) ======
  service_llm:
    build:
      context: ./service_llm
      dockerfile: Dockerfile
    container_name: conecta-service-llm
    restart: unless-stopped
    env_file: .env
    dns:
      - 8.8.8.8
    ports:
      - '8003:8001'
    deploy:
      resources:
        limits:
          memory: 512M

  # ====== WHATSAPP AGENT ======
  whatsapp-agent:
    build:
      context: ./service_agente_whatsapp
      dockerfile: Dockerfile
    container_name: conecta-whatsapp-agent
    restart: unless-stopped
    env_file: .env
    dns:
      - 8.8.8.8
    ports:
      - '8002:8001'
    depends_on:
      - backend
      - redis
    deploy:
      resources:
        limits:
          memory: 256M

  # ====== AUDIO SUMARIZADO ======
  service_agente_audio_sumarizado:
    build:
      context: ./service_agente_audio_sumarizado
      dockerfile: Dockerfile
    container_name: conecta-audio-sumarizado
    restart: unless-stopped
    env_file: .env
    dns:
      - 8.8.8.8
    ports:
      - '8004:8003'
    depends_on:
      - backend
    volumes:
      - audio_uploads:/app/uploads
    deploy:
      resources:
        limits:
          memory: 350M

  # ====== FRONTEND ======
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=http://backend:8000
        - VITE_WHATSAPP_AGENT_URL=http://service_agente_whatsapp:8001/api/v1
        - VITE_AUDIO_AGENT_URL=http://service_agente_audio_sumarizado:8003/api/v1
    container_name: conecta-frontend
    restart: unless-stopped
    env_file: .env
    ports:
      - '5173:80'
    depends_on:
      - backend
    deploy:
      resources:
        limits:
          memory: 128M

volumes:
  audio_uploads:
    driver: local

networks:
  default:
    name: conecta-network
    driver: bridge
