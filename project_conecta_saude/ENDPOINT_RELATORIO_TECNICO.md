# üîß Guia T√©cnico: Implementa√ß√£o do Endpoint de Relat√≥rio no Backend\n\n## Objetivo\n\nCriar endpoint para que o **agente de sumariza√ß√£o** (ou qualquer outro servi√ßo) possa atualizar o relat√≥rio de uma visita realizada.\n\n---\n\n## Endpoint a Implementar\n\n### `PUT /api/v1/agentes/{agente_id}/atribuicoes/{atribuicao_id}/relatorio`\n\n**Autentica√ß√£o:** Token JWT Bearer\n\n**Body (JSON):**\n\n```json\n{\n  \"data_visita_realizada\": \"2024-01-15T14:45:00Z\",\n  \"anotacoes_visita\": \"Paciente estava bem-disposto. Press√£o arterial controlada. Pr√≥ximo retorno em 30 dias.\",\n  \"relatorio_visita\": {\n    \"resumo\": \"Visita realizada com sucesso\",\n    \"dados_coletados\": {\n      \"pressao_arterial\": \"120/80 mmHg\",\n      \"peso\": \"75 kg\",\n      \"temperatura\": \"36.5¬∞C\"\n    },\n    \"observacoes\": \"Paciente aderindo bem ao tratamento\",\n    \"recomendacoes\": [\n      \"Continuar medica√ß√£o prescrita\",\n      \"Retorno em 30 dias\",\n      \"Se houver sintomas, procurar UPA\"\n    ],\n    \"dados_ia\": {\n      \"risco_nivel\": \"baixo\",\n      \"intervencoes_sugeridas\": [\"acompanhamento rotineiro\"],\n      \"proxima_acao_recomendada\": \"retorno_agendado\"\n    }\n  }\n}\n```\n\n**Response (200 OK):**\n\n```json\n{\n  \"id\": 123,\n  \"agente_id\": 45,\n  \"paciente_id\": 78,\n  \"nome_paciente\": \"Jo√£o Silva\",\n  \"ativo\": true,\n  \"data_atribuicao\": \"2024-01-15T08:00:00Z\",\n  \"data_visita_planejada\": \"2024-01-15T14:30:00Z\",\n  \"data_visita_realizada\": \"2024-01-15T14:45:00Z\",\n  \"anotacoes_visita\": \"Paciente estava bem-disposto...\",\n  \"relatorio_visita\": { ... },\n  \"created_at\": \"2024-01-15T08:00:00Z\",\n  \"updated_at\": \"2024-01-15T15:00:00Z\"\n}\n```\n\n---\n\n## Implementa√ß√£o no Backend\n\n### 1. Atualizar Schema (`app/schemas/agente_schema.py`)\n\n```python\nclass RelatorioVisitaUpdate(BaseModel):\n    \"\"\"Schema para atualizar relat√≥rio de visita\"\"\"\n    data_visita_realizada: Optional[datetime] = Field(\n        None, \n        description=\"Data e hora em que a visita foi realizada\"\n    )\n    anotacoes_visita: Optional[str] = Field(\n        None, \n        description=\"Anota√ß√µes do agente durante/ap√≥s a visita\"\n    )\n    relatorio_visita: Optional[Dict[str, Any]] = Field(\n        None, \n        description=\"Relat√≥rio estruturado da visita (do agente de sumariza√ß√£o)\"\n    )\n\n    class Config:\n        json_schema_extra = {\n            \"example\": {\n                \"data_visita_realizada\": \"2024-01-15T14:45:00Z\",\n                \"anotacoes_visita\": \"Visita realizada com sucesso\",\n                \"relatorio_visita\": {\n                    \"resumo\": \"...\",\n                    \"observacoes\": \"...\"\n                }\n            }\n        }\n```\n\n### 2. Criar M√©todo no Service (`app/services/agente_service.py`)\n\nAdicionar √† classe `AtribuicaoPacienteService`:\n\n```python\n@staticmethod\nasync def atualizar_relatorio(\n    db: Session,\n    agente_id: int,\n    atribuicao_id: int,\n    dados: RelatorioVisitaUpdate,\n) -> Optional[AtribuicaoPaciente]:\n    \"\"\"\n    Atualiza o relat√≥rio de uma visita realizada.\n    \n    Args:\n        db: Sess√£o do banco de dados\n        agente_id: ID do agente\n        atribuicao_id: ID da atribui√ß√£o\n        dados: Dados do relat√≥rio\n        \n    Returns:\n        AtribuicaoPaciente atualizada ou None se n√£o encontrada\n    \"\"\"\n    atribuicao = db.query(AtribuicaoPaciente).filter(\n        AtribuicaoPaciente.id == atribuicao_id,\n        AtribuicaoPaciente.agente_id == agente_id,\n    ).first()\n    \n    if not atribuicao:\n        return None\n    \n    # Atualizar apenas os campos fornecidos\n    if dados.data_visita_realizada:\n        atribuicao.data_visita_realizada = dados.data_visita_realizada\n    \n    if dados.anotacoes_visita:\n        atribuicao.anotacoes_visita = dados.anotacoes_visita\n    \n    if dados.relatorio_visita:\n        atribuicao.relatorio_visita = dados.relatorio_visita\n    \n    # Marcar como conclu√≠do se tiver relat√≥rio\n    if dados.relatorio_visita or dados.data_visita_realizada:\n        atribuicao.data_conclusao = datetime.now(timezone.utc)\n    \n    db.commit()\n    db.refresh(atribuicao)\n    \n    return atribuicao\n```\n\n### 3. Criar Rota (`app/routes/agente_routes.py`)\n\nAdicionar novo endpoint:\n\n```python\nfrom app.schemas.agente_schema import RelatorioVisitaUpdate\nfrom app.services.agente_service import AtribuicaoPacienteService\n\n# Supondo que o router est√° como: router = APIRouter(prefix=\"/api/v1/agentes\")\n\n@router.put(\n    \"/{agente_id}/atribuicoes/{atribuicao_id}/relatorio\",\n    response_model=AtribuicaoPaciente,\n    summary=\"Atualizar relat√≥rio de visita\",\n    description=\"Permite atualizar o relat√≥rio de uma visita realizada. Normalmente chamado pelo agente de sumariza√ß√£o.\",\n    tags=[\"Atribui√ß√µes de Pacientes\"],\n)\nasync def atualizar_relatorio_visita(\n    agente_id: int,\n    atribuicao_id: int,\n    dados: RelatorioVisitaUpdate,\n    current_user: dict = Depends(get_current_user),\n    db: Session = Depends(get_db),\n):\n    \"\"\"\n    Atualiza o relat√≥rio de uma visita realizada.\n    \n    **Campos aceitos:**\n    - `data_visita_realizada`: Data/hora em que a visita foi feita\n    - `anotacoes_visita`: Anota√ß√µes do agente durante a visita\n    - `relatorio_visita`: Relat√≥rio estruturado em JSON (ex: do agente de sumariza√ß√£o)\n    \n    **Exemplo de uso:**\n    ```\n    PUT /api/v1/agentes/45/atribuicoes/123/relatorio\n    Content-Type: application/json\n    Authorization: Bearer <token>\n    \n    {\n      \"data_visita_realizada\": \"2024-01-15T14:45:00Z\",\n      \"anotacoes_visita\": \"Visita realizada com sucesso\",\n      \"relatorio_visita\": {\n        \"resumo\": \"...\",\n        \"observacoes\": \"...\"\n      }\n    }\n    ```\n    \"\"\"\n    # Verificar se agente existe e pertence ao usu√°rio\n    agente = db.query(AgenteHealthcare).filter(\n        AgenteHealthcare.id == agente_id\n    ).first()\n    \n    if not agente:\n        raise HTTPException(\n            status_code=404,\n            detail=\"Agente n√£o encontrado\"\n        )\n    \n    # Atualizar relat√≥rio\n    atribuicao = await AtribuicaoPacienteService.atualizar_relatorio(\n        db=db,\n        agente_id=agente_id,\n        atribuicao_id=atribuicao_id,\n        dados=dados,\n    )\n    \n    if not atribuicao:\n        raise HTTPException(\n            status_code=404,\n            detail=\"Atribui√ß√£o n√£o encontrada\"\n        )\n    \n    return atribuicao\n```\n\n---\n\n## Como Chamar do Agente de Sumariza√ß√£o\n\n### Exemplo em Python:\n\n```python\nimport requests\nfrom datetime import datetime\n\n# Dados da visita processados pelo agente de IA\nrelatorio = {\n    \"data_visita_realizada\": datetime.now().isoformat(),\n    \"anotacoes_visita\": \"Paciente apresentava bom estado geral. Press√£o controlada.\",\n    \"relatorio_visita\": {\n        \"resumo\": \"Visita de acompanhamento realizada com sucesso\",\n        \"dados_coletados\": {\n            \"pressao_arterial\": \"120/80\",\n            \"peso\": \"75kg\",\n            \"temperatura\": \"36.5C\"\n        },\n        \"observacoes\": \"Paciente aderindo bem ao tratamento\",\n        \"recomendacoes\": [\n            \"Continuar medica√ß√£o\",\n            \"Retorno em 30 dias\"\n        ],\n        \"risco_nivel\": \"baixo\"\n    }\n}\n\n# Fazer requisi√ß√£o\ntry:\n    response = requests.put(\n        f\"http://localhost:8082/api/v1/agentes/{agente_id}/atribuicoes/{atribuicao_id}/relatorio\",\n        json=relatorio,\n        headers={\n            \"Authorization\": f\"Bearer {token}\",\n            \"Content-Type\": \"application/json\"\n        },\n        timeout=10\n    )\n    \n    if response.status_code == 200:\n        print(\"‚úÖ Relat√≥rio atualizado com sucesso\")\n        print(response.json())\n    else:\n        print(f\"‚ùå Erro {response.status_code}: {response.text}\")\n        \nexcept Exception as e:\n    print(f\"‚ùå Erro na requisi√ß√£o: {e}\")\n```\n\n### Exemplo em JavaScript/Node.js:\n\n```javascript\nconst fetch = require('node-fetch');\n\nconst relatorio = {\n  data_visita_realizada: new Date().toISOString(),\n  anotacoes_visita: \"Paciente bem-disposto e aderindo ao tratamento\",\n  relatorio_visita: {\n    resumo: \"Visita realizada com sucesso\",\n    dados_coletados: {\n      pressao_arterial: \"120/80\",\n      peso: \"75kg\"\n    },\n    observacoes: \"Tudo normal\",\n    recomendacoes: [\"Retorno em 30 dias\"],\n    risco_nivel: \"baixo\"\n  }\n};\n\nfetch(\n  `http://localhost:8082/api/v1/agentes/${agente_id}/atribuicoes/${atribuicao_id}/relatorio`,\n  {\n    method: 'PUT',\n    headers: {\n      'Authorization': `Bearer ${token}`,\n      'Content-Type': 'application/json'\n    },\n    body: JSON.stringify(relatorio)\n  }\n)\n.then(res => res.json())\n.then(data => console.log('‚úÖ Sucesso:', data))\n.catch(err => console.error('‚ùå Erro:', err));\n```\n\n---\n\n## Valida√ß√µes Recomendadas\n\n```python\n# No m√©todo atualizar_relatorio, adicionar valida√ß√µes:\n\nif dados.data_visita_realizada:\n    # N√£o permitir data no futuro\n    if dados.data_visita_realizada > datetime.now(timezone.utc):\n        raise ValueError(\"Data da visita n√£o pode ser no futuro\")\n    \n    # N√£o permitir data anterior √† data de atribui√ß√£o\n    if dados.data_visita_realizada < atribuicao.data_atribuicao:\n        raise ValueError(\"Data da visita n√£o pode ser anterior √† data de atribui√ß√£o\")\n\nif dados.anotacoes_visita:\n    # Validar tamanho m√≠nimo\n    if len(dados.anotacoes_visita.strip()) < 10:\n        raise ValueError(\"Anota√ß√µes devem ter pelo menos 10 caracteres\")\n\nif dados.relatorio_visita:\n    # Validar que √© um dicion√°rio v√°lido\n    if not isinstance(dados.relatorio_visita, dict):\n        raise ValueError(\"Relat√≥rio deve ser um objeto JSON v√°lido\")\n```\n\n---\n\n## Testes Recomendados\n\n### Teste com curl:\n\n```bash\n# Atualizar relat√≥rio\ncurl -X PUT http://localhost:8082/api/v1/agentes/45/atribuicoes/123/relatorio \\\n  -H \"Authorization: Bearer SEU_TOKEN\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"data_visita_realizada\": \"2024-01-15T14:45:00Z\",\n    \"anotacoes_visita\": \"Visita realizada com sucesso\",\n    \"relatorio_visita\": {\n      \"resumo\": \"Tudo ok\",\n      \"risco_nivel\": \"baixo\"\n    }\n  }'\n```\n\n### Teste com Postman:\n\n1. Method: `PUT`\n2. URL: `http://localhost:8082/api/v1/agentes/45/atribuicoes/123/relatorio`\n3. Headers:\n   - `Authorization: Bearer SEU_TOKEN`\n   - `Content-Type: application/json`\n4. Body (raw JSON):\n   ```json\n   {\n     \"data_visita_realizada\": \"2024-01-15T14:45:00Z\",\n     \"anotacoes_visita\": \"Visita realizada com sucesso\",\n     \"relatorio_visita\": { ... }\n   }\n   ```\n\n---\n\n## Campos da Resposta\n\n```json\n{\n  \"id\": 123,                              // ID da atribui√ß√£o\n  \"agente_id\": 45,                        // ID do agente\n  \"paciente_id\": 78,                      // ID do paciente\n  \"nome_paciente\": \"Jo√£o Silva\",          // Nome do paciente (snapshot)\n  \"localizacao\": \"Rua...\",                 // Localiza√ß√£o da visita\n  \"informacoes_clinicas\": { ... },       // Dados cl√≠nicos do paciente\n  \"notas_gestor\": \"...\",                  // Notas deixadas pelo gestor\n  \"ativo\": true,                          // Se est√° ativo\n  \"data_atribuicao\": \"2024-01-15T08:00:00Z\", // Quando foi atribu√≠do\n  \"data_visita_planejada\": \"2024-01-15T14:30:00Z\", // Data planejada\n  \"data_visita_realizada\": \"2024-01-15T14:45:00Z\", // Data real [NOVO]\n  \"anotacoes_visita\": \"...\",              // Anota√ß√µes do agente [NOVO]\n  \"relatorio_visita\": { ... },            // Relat√≥rio da IA [NOVO]\n  \"data_conclusao\": \"2024-01-15T15:00:00Z\", // Quando foi conclu√≠do\n  \"created_at\": \"2024-01-15T08:00:00Z\",\n  \"updated_at\": \"2024-01-15T15:00:00Z\"\n}\n```\n\n---\n\n## Seguran√ßa\n\n- ‚úÖ Requer autentica√ß√£o (Bearer token)\n- ‚úÖ Validar que agente_id pertence ao usu√°rio autenticado\n- ‚úÖ Rate limiting para evitar spam\n- ‚úÖ Validar tamanho m√°ximo de dados JSON (ex: 5MB)\n- ‚úÖ Sanitizar dados de entrada\n- ‚úÖ Log de altera√ß√µes para auditoria\n\n---\n\n## Integra√ß√£o com Frontend\n\nO frontend **automaticamente exibir√°** o relat√≥rio quando os dados forem salvos no banco, sem necessidade de altera√ß√µes adicionais na UI.\n\nO modal de visualiza√ß√£o de relat√≥rios na p√°gina de Agentes j√° est√° pronto para exibir:\n- `data_visita_realizada`\n- `anotacoes_visita`\n- `relatorio_visita`\n\n
